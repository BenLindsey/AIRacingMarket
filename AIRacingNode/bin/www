#!/usr/bin/env node
var debug = require('debug')('AIRacingNode');
var app = require('../app');


// FIND/CREATE port for branch

var branch = process.env.BRANCH;

console.log("Found branch " + branch);

var port = 3000;

var configDB = require('../config/database.js');
var mongo = require('mongodb');
var monk = require('monk');
var db = monk(configDB.url);

var collection = db.get('redirectcollection');

var found = false;

collection.find({}, {}, function(e, docs) {
    docs.forEach(function (doc) {
        console.log("Checking doc");

        if(doc.branch === branch) {
            found = true;
            port = doc.port;
            console.log("Found port " + port);
        }

        if(!found && doc.port >= port) {
            port = doc.port + 1;
        }
    });
});

if(!found) {
    collection.insert({"branch" : branch, "port" : port});
    console.log("Created port " + port);
}

// END

app.set('port', port);

var server = app.listen(app.get('port'), function() {
    console.log('Express server listening on port ' + server.address().port);
});
